<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Textbook Submissions</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--color-burgundy);
        }

        .admin-header h1 {
            font-family: var(--font-display);
            color: var(--color-navy);
            margin: 0;
        }

        .refresh-btn {
            padding: 0.5rem 1.5rem;
            background: var(--color-burgundy);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: var(--color-navy);
            transform: translateY(-2px);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--color-cream) 0%, var(--color-cream-dark) 100%);
            border-radius: 8px;
            border-left: 4px solid var(--color-gold);
        }

        .stat-card h3 {
            font-size: 0.875rem;
            color: var(--color-slate);
            margin: 0 0 0.5rem 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-card p {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-navy);
            margin: 0;
            font-family: var(--font-display);
        }

        .submissions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .submissions-table thead {
            background: linear-gradient(135deg, var(--color-navy) 0%, var(--color-navy-light) 100%);
            color: white;
        }

        .submissions-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .submissions-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--color-slate-lighter);
        }

        .submissions-table tr:hover {
            background-color: var(--color-cream);
        }

        .condition-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .condition-like-new {
            background: #d4edda;
            color: #155724;
        }

        .condition-good {
            background: #d1ecf1;
            color: #0c5460;
        }

        .condition-acceptable {
            background: #fff3cd;
            color: #856404;
        }

        .condition-poor {
            background: #f8d7da;
            color: #721c24;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--color-slate);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--color-slate);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            border-left: 4px solid #721c24;
        }

        .export-btn {
            padding: 0.5rem 1.5rem;
            background: var(--color-gold);
            color: var(--color-navy);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-left: 0.5rem;
        }

        .export-btn:hover {
            background: var(--color-gold-light);
            transform: translateY(-2px);
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body style="background: var(--color-cream);">
    <div class="admin-container">
        <div class="admin-header">
            <h1>Textbook Submissions</h1>
            <div>
                <button class="export-btn" onclick="exportToCSV()">Export CSV</button>
                <button class="refresh-btn" onclick="loadSubmissions()">Refresh</button>
            </div>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>Total Submissions</h3>
                <p id="totalSubmissions">-</p>
            </div>
            <div class="stat-card">
                <h3>Today</h3>
                <p id="todaySubmissions">-</p>
            </div>
            <div class="stat-card">
                <h3>This Week</h3>
                <p id="weekSubmissions">-</p>
            </div>
        </div>

        <div id="errorContainer"></div>
        <div id="tableContainer">
            <div class="loading">Loading submissions...</div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>

    <script>
        let allSubmissions = [];

        // Load submissions on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSubmissions();
        });

        async function loadSubmissions() {
            const container = document.getElementById('tableContainer');
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = '';

            // Check if Firebase is configured
            if (typeof db === 'undefined') {
                loadLocalStorageSubmissions();
                return;
            }

            try {
                container.innerHTML = '<div class="loading">Loading submissions from Firebase...</div>';

                const snapshot = await db.collection('textbook_submissions')
                    .orderBy('createdAt', 'desc')
                    .get();

                allSubmissions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                updateStats(allSubmissions);
                renderTable(allSubmissions);
            } catch (error) {
                console.error('Error loading submissions:', error);
                errorContainer.innerHTML = `
                    <div class="error-message">
                        <strong>Error loading from Firebase:</strong> ${error.message}
                        <br><small>Falling back to localStorage...</small>
                    </div>
                `;
                loadLocalStorageSubmissions();
            }
        }

        function loadLocalStorageSubmissions() {
            const submissions = JSON.parse(localStorage.getItem('textbookSubmissions') || '[]');
            allSubmissions = submissions.map((sub, index) => ({
                id: sub.firestoreId || `local-${index}`,
                ...sub
            }));

            updateStats(allSubmissions);
            renderTable(allSubmissions);
        }

        function updateStats(submissions) {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            const todayCount = submissions.filter(sub => {
                const subDate = new Date(sub.submittedAt || sub.createdAt?.toDate?.());
                return subDate >= todayStart;
            }).length;

            const weekCount = submissions.filter(sub => {
                const subDate = new Date(sub.submittedAt || sub.createdAt?.toDate?.());
                return subDate >= weekStart;
            }).length;

            document.getElementById('totalSubmissions').textContent = submissions.length;
            document.getElementById('todaySubmissions').textContent = todayCount;
            document.getElementById('weekSubmissions').textContent = weekCount;
        }

        function renderTable(submissions) {
            const container = document.getElementById('tableContainer');

            if (submissions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <h2>No submissions yet</h2>
                        <p>Textbook submissions will appear here once users submit the form.</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table class="submissions-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>ISBN</th>
                            <th>Book Title</th>
                            <th>Condition</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${submissions.map(sub => `
                            <tr>
                                <td>${formatDate(sub.submittedAt || sub.createdAt)}</td>
                                <td>${sub.fullName || '-'}</td>
                                <td>${sub.email || '-'}</td>
                                <td>${sub.phone || '-'}</td>
                                <td>${sub.isbn || '-'}</td>
                                <td>${sub.bookTitle || '-'}</td>
                                <td><span class="condition-badge condition-${sub.bookCondition}">${sub.bookCondition || '-'}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        function formatDate(date) {
            if (!date) return '-';

            // Handle Firestore Timestamp
            if (date.toDate) {
                date = date.toDate();
            } else if (typeof date === 'string') {
                date = new Date(date);
            }

            return new Intl.DateTimeFormat('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }

        function exportToCSV() {
            if (allSubmissions.length === 0) {
                alert('No submissions to export');
                return;
            }

            const headers = ['Date', 'Name', 'Email', 'Phone', 'ISBN', 'Book Title', 'Author', 'Condition', 'Notes'];
            const rows = allSubmissions.map(sub => [
                formatDate(sub.submittedAt || sub.createdAt),
                sub.fullName || '',
                sub.email || '',
                sub.phone || '',
                sub.isbn || '',
                sub.bookTitle || '',
                sub.bookAuthor || '',
                sub.bookCondition || '',
                sub.additionalNotes || ''
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `textbook-submissions-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
